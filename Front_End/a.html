<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Weather & Danger Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <style>
    body {
      background: #f8f9fa;
      font-family: 'Segoe UI', sans-serif;
    }
    #map {
      height: 550px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    .map-container {
      margin: 40px auto;
      max-width: 1100px;
    }
  </style>
</head>
<body>

<div class="container map-container">
  <h2 class="text-center mb-4 fw-bold">üåç Live Weather & Danger Map</h2>
  <div id="map"></div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
  // 1Ô∏è‚É£ Initialize Map
  const map = L.map('map').setView([7.8731, 80.7718], 7); // Default Sri Lanka

  // 2Ô∏è‚É£ Base Layer
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  // 3Ô∏è‚É£ Weather Layers (OpenWeatherMap)
  const API_KEY = "YOUR_API_KEY"; // <<< put your OpenWeatherMap key here

  const rainLayer = L.tileLayer(
          `https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=${API_KEY}`,
          { attribution: "Weather ¬© OpenWeatherMap" }
  );

  const cloudsLayer = L.tileLayer(
          `https://tile.openweathermap.org/map/clouds_new/{z}/{x}/{y}.png?appid=${API_KEY}`,
          { attribution: "Weather ¬© OpenWeatherMap" }
  );

  const tempLayer = L.tileLayer(
          `https://tile.openweathermap.org/map/temp_new/{z}/{x}/{y}.png?appid=${API_KEY}`,
          { attribution: "Weather ¬© OpenWeatherMap" }
  );

  // Add one default
  rainLayer.addTo(map);

  // Layer Control
  const overlayMaps = {
    "üåß Rain": rainLayer,
    "‚òÅ Clouds": cloudsLayer,
    "üå° Temperature": tempLayer
  };
  L.control.layers(null, overlayMaps).addTo(map);

  // 4Ô∏è‚É£ Fetch Danger Reports from Backend
  async function loadReports() {
    try {
      const accessToken = localStorage.getItem("accessToken");
      const res = await fetch("http://localhost:8080/auth/reports/all", {
        headers: { "Authorization": `Bearer ${accessToken}` }
      });

      if (!res.ok) throw new Error("Failed to load reports");

      const data = await res.json();

      data.data.forEach(r => {
        if (r.latitude && r.longitude) {
          const marker = L.marker([r.latitude, r.longitude]).addTo(map);
          marker.bindPopup(`
            <b>‚ö† ${r.type}</b><br>
            ${r.description}<br>
            <small><i>${r.reporterContact || "No contact"}</i></small>
          `);
        }
      });
    } catch (err) {
      console.error(err);
      alert("Error loading danger reports!");
    }
  }

  loadReports();
</script>

</body>
</html>
