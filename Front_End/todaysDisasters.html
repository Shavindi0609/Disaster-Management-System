<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Today's Disasters - NDMRS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body { background-color: #f8f9fa; font-family: Arial, sans-serif; }
    .sidebar { width: 220px; height: 100vh; background: #066150; color: white; position: fixed; }
    .sidebar ul { list-style: none; padding: 0; }
    .sidebar ul li { padding: 12px; }
    .sidebar ul li a { color: white; text-decoration: none; display: block; }
    .sidebar ul li a.active, .sidebar ul li a:hover { background-color: #1D865C; border-radius: 5px; }
    #page-content { margin-left: 220px; padding: 20px; }
    #disasterMap { height: 500px; border-radius: 10px; }
    .filter-container { margin-bottom: 15px; }
  </style>
</head>
<body>
<div class="sidebar">
  <h3 class="text-center py-3">NDMRS</h3>
  <ul>
    <li><a href="userDashboard.html"><i class="fas fa-home"></i> Dashboard</a></li>
    <li><a href="report.html"><i class="fas fa-exclamation-triangle"></i> Report Disaster</a></li>
    <li><a href="myReports.html"><i class="fas fa-file-alt"></i> My Reports</a></li>
    <li><a href="signUp.html" id="logoutLink"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
  </ul>
</div>

<div id="page-content">
  <h2><i class="fas fa-map-marker-alt"></i> Today's Reported Disasters</h2>

  <div class="filter-container">
    <label for="filterType" class="form-label">Filter by Type:</label>
    <select id="filterType" class="form-select w-auto">
      <option value="all">All</option>
      <option value="Flood">Flood</option>
      <option value="Cyclone">Cyclone</option>
      <option value="Earthquake">Earthquake</option>
      <option value="Landslide">Landslide</option>
    </select>
  </div>

  <div id="disasterMap"></div>

  <div class="mt-2">
    <small><b>Legend:</b>
      <span style="color:blue">● Flood</span> |
      <span style="color:green">● Cyclone</span> |
      <span style="color:orange">● Landslide</span> |
      <span style="color:red">● Earthquake</span>
    </small>
  </div>
</div>

<script>
  const accessToken = localStorage.getItem("accessToken");
  if (!accessToken) {
    alert("⚠️ Please login first!");
    window.location.href = "signUp.html";
  }

  const map = L.map("disasterMap").setView([7.8731, 80.7718], 7);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap contributors"
  }).addTo(map);

  let allMarkers = [];

  function loadDisasters(filter = "all") {
    fetch("http://localhost:8080/api/reports/today", {
      headers: { "Authorization": `Bearer ${accessToken}` }
    })
            .then(res => res.json())
            .then(data => {
              allMarkers.forEach(m => map.removeLayer(m));
              allMarkers = [];

              const reports = data.data || [];
              reports.forEach(r => {
                if (r.latitude && r.longitude && (filter === "all" || r.type === filter)) {
                  const color = r.type === "Flood" ? "blue" :
                          r.type === "Cyclone" ? "green" :
                                  r.type === "Landslide" ? "orange" :
                                          "red";

                  const marker = L.circleMarker([r.latitude, r.longitude], {
                    radius: 8, color: color, fillColor: color, fillOpacity: 0.7
                  }).addTo(map)
                          .bindPopup(`<b>${r.type}</b><br>${r.description || ""}`);
                  allMarkers.push(marker);
                }
              });
            })
            .catch(err => console.error("Error loading reports:", err));
  }

  // Load all disasters by default
  loadDisasters();

  // Filter dropdown
  document.getElementById("filterType").addEventListener("change", e => {
    loadDisasters(e.target.value);
  });

  // Logout
  document.getElementById("logoutLink").addEventListener("click", e => {
    e.preventDefault();
    localStorage.clear();
    window.location.href = "signUp.html";
  });
</script>
</body>
</html>
