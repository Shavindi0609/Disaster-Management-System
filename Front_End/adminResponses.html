<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin - Volunteer Responses</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { background-color: #f8f9fa; font-family: Arial, sans-serif; }
    .card { border-radius: 12px; margin-bottom: 20px; box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
    .response-map { height: 180px; border-radius: 8px; margin-top: 10px; border: 2px solid #1D865C; }
    h2 { color: #066150; margin-top: 20px; margin-bottom: 15px; }
    .text-muted { font-style: italic; }
    .response-card { margin-bottom: 10px; padding: 10px; border-radius: 8px; background-color: #e9f5f1; }
  </style>
</head>
<body>
<div class="container mt-4">
  <h2>All Reports & Volunteer Responses</h2>
  <div id="responsesContainer"></div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const token = localStorage.getItem("accessToken");
    if (!token) {
      alert("⚠️ Please login first!");
      window.location.href = "signUp.html";
      return;
    }

    const container = document.getElementById("responsesContainer");
    container.innerHTML = "<p>Loading reports...</p>";

    try {
      // Fetch all reports
      const res = await fetch("http://localhost:8080/api/reports/all", {
        headers: { "Authorization": `Bearer ${token}` }
      });
      const data = await res.json();
      const reports = data.data || [];

      if (reports.length === 0) {
        container.innerHTML = "<p>No reports available.</p>";
        return;
      }

      container.innerHTML = "";

      for (let report of reports) {
        const div = document.createElement("div");
        div.className = "card p-3 mb-3";

        // Fetch responses for this report
        let responsesHTML = "<p class='text-muted'>No response yet</p>";
        try {
          const respRes = await fetch(`http://localhost:8080/api/responses/report/${report.id}`, {
            headers: { "Authorization": `Bearer ${token}` }
          });
          const respData = await respRes.json();
          const responses = respData.data || [];

          if (responses.length > 0) {
            responsesHTML = "";
            responses.forEach(resp => {
              responsesHTML += `
              <div class="response-card">
                <p>${resp.statusUpdate}</p>
                <p><b>Date:</b> ${new Date(resp.respondedAt).toLocaleString()}</p>
                ${resp.photoBase64 ? `<img src="data:image/jpeg;base64,${resp.photoBase64}" style="max-width:150px;" class="rounded" />` : ""}
              </div>
            `;
            });
          }
        } catch(err) {
          console.warn("No responses or error fetching for report " + report.id, err);
        }

        div.innerHTML = `
        <div class="row">
          <!-- Left side: Report -->
          <div class="col-md-6">
            <h5>${report.type}</h5>
            <p>${report.description}</p>
            <p><b>Reporter:</b> ${report.reporterContact || 'N/A'}</p>
            <p><b>Assigned Volunteer:</b> ${report.assignedVolunteer ? report.assignedVolunteer.name : 'Not Assigned'}</p>
            <div id="map-${report.id}" class="response-map"></div>
          </div>

          <!-- Right side: Responses -->
          <div class="col-md-6">
            <h6>Responses</h6>
            ${responsesHTML}
          </div>
        </div>
      `;

        container.appendChild(div);

        // Initialize map
        const map = L.map(`map-${report.id}`, { zoomControl: false, dragging: false })
                .setView([report.latitude, report.longitude], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        L.marker([report.latitude, report.longitude]).addTo(map);
      }

    } catch (err) {
      console.error(err);
      container.innerHTML = `<p class="text-danger">Error: ${err.message}</p>`;
    }
  });
</script>
</body>
</html>
