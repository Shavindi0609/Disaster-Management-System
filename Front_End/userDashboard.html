<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Victim Dashboard - NDMRS</title>
    <link rel="stylesheet" href="css/userDashboard.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
<div class="d-flex" id="wrapper">
    <!-- User Sidebar -->
    <div class="sidebar">
        <div class="brand text-center mb-4">
            <i class="fas fa-shield-alt fa-2x"></i> <!-- icon size increased -->
            <h2 class="mt-2">NDMRS</h2>
        </div>
        <ul class="list-unstyled">
            <li><a href="userDashboard.html" class="active">
                <i class="fas fa-home"></i> Dashboard</a></li>
            <li><a href="report.html">
                <i class="fas fa-exclamation-triangle"></i> Report Disaster</a></li>
            <li><a href="myReports.html">
                <i class="fas fa-file-alt"></i> My Reports</a></li>
            <li><a href="profile.html">
                <i class="fas fa-user"></i> Profile</a></li>
            <li><a href="donation.html">
                <i class="fas fa-donate"></i> Donations</a></li>
            <li><a href="signUp.html" id="logoutLink">
                <i class="fas fa-sign-out-alt"></i> Logout</a></li>
        </ul>
    </div>

    <!-- Main Content -->
    <div id="page-content" class="p-4">
        <!-- Welcome Card (smaller) -->
        <div class="welcome-card p-3 mb-3 shadow-sm rounded d-flex align-items-center justify-content-between">
            <div>
                <h5 class="mb-0">Welcome, <span id="username">Victim User</span> üëã</h5>
                <p class="text-muted mb-0" style="font-size: 0.85rem;">Here‚Äôs an overview of your activities</p>
            </div>
            <div class="user-avatar">
                <i class="fas fa-user-circle fa-2x text-secondary"></i>
            </div>
        </div>


        <!-- Disaster Map -->
        <div class="mt-3">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-map-marker-alt"></i> Today‚Äôs Reported Disasters</h5>
                    <select id="filterType" class="form-select w-auto">
                        <option value="all">All</option>
                        <option value="Flood">Flood</option>
                        <option value="Cyclone">Cyclone</option>
                        <option value="Earthquake">Earthquake</option>
                        <option value="Landslide">Landslide</option>
                    </select>
                </div>
                <div class="card-body p-0">
                    <div id="todayDisastersMap" style="height: 350px; border-radius: 0 0 15px 15px;"></div>
                </div>
                <div class="p-3">
                    <small><b>Legend:</b>
                        <span style="color:blue">‚óè Flood</span> |
                        <span style="color:green">‚óè Cyclone</span> |
                        <span style="color:orange">‚óè Landslide</span> |
                        <span style="color:red">‚óè Earthquake</span>
                    </small>
                </div>
            </div>
        </div>

        <!-- Recent Reports -->
        <div class="mt-4">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="fas fa-history"></i> Recent Reports</h5>
                </div>
                <div class="card-body">
                    <ul id="recentReports" class="list-group list-group-flush"></ul>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="row g-4">
            <div class="col-md-4">
                <div class="card stat-card shadow-sm text-center">
                    <div class="card-body">
                        <i class="fas fa-file-alt fa-2x text-primary mb-2"></i>
                        <h5>My Reports</h5>
                        <p id="report-count">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card shadow-sm text-center">
                    <div class="card-body">
                        <i class="fas fa-hand-holding-usd fa-2x text-success mb-2"></i>
                        <h5>Aid Received</h5>
                        <p id="aid-count">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card shadow-sm text-center">
                    <div class="card-body">
                        <i class="fas fa-hourglass-half fa-2x text-warning mb-2"></i>
                        <h5>Pending Requests</h5>
                        <p id="pending-count">0</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const accessToken = localStorage.getItem("accessToken");
        const username = localStorage.getItem("username");

        if (!accessToken) {
            alert("‚ö†Ô∏è You must be logged in to access this page.");
            window.location.href = "signIn.html";
            return;
        }

        // Set username
        if (username) document.getElementById("username").textContent = username;

        // Logout
        // document.getElementById("logoutLink").addEventListener("click", e => {
        //     e.preventDefault();
        //     localStorage.clear();
        //     window.location.href = "signIn.html";
        // });

        // Initialize map
        const map = L.map("todayDisastersMap").setView([7.8731, 80.7718], 7);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "&copy; OpenStreetMap contributors"
        }).addTo(map);

        let allMarkers = [];

        function loadDisasters(filter = "all") {
            fetch("http://localhost:8080/api/reports/today", {
                headers: { "Authorization": `Bearer ${accessToken}` }
            })
                .then(res => res.json())
                .then(data => {
                    allMarkers.forEach(m => map.removeLayer(m));
                    allMarkers = [];

                    const reports = data.data || [];
                    reports.forEach(r => {
                        if (r.latitude && r.longitude && (filter === "all" || r.type === filter)) {
                            const color = r.type === "Flood" ? "blue" :
                                r.type === "Cyclone" ? "green" :
                                    r.type === "Landslide" ? "orange" :
                                        "red";

                            const marker = L.circleMarker([r.latitude, r.longitude], {
                                radius: 8, color: color, fillColor: color, fillOpacity: 0.7
                            }).addTo(map)
                                .bindPopup(`<b>${r.type}</b><br>${r.description || ""}`);
                            allMarkers.push(marker);
                        }
                    });
                })
                .catch(err => console.error("Error loading reports:", err));
        }

        // Load all disasters by default
        loadDisasters();

        // Filter dropdown
        document.getElementById("filterType").addEventListener("change", e => {
            loadDisasters(e.target.value);
        });

        // Load user reports count
        fetch("http://localhost:8080/api/reports/my", {
            headers: { "Authorization": `Bearer ${accessToken}` }
        })
            .then(res => res.json())
            .then(data => {
                const count = data.data ? data.data.length : 0;
                document.getElementById("report-count").textContent = count;

                // Show recent 5 reports
// Show recent 3 reports
// Show latest 3 reports
                const recent = document.getElementById("recentReports");
                recent.innerHTML = ""; // clear previous entries

                const reports = (data.data || []).sort((a, b) => new Date(b.date) - new Date(a.date)); // newest first

                reports.slice(0, 3).forEach(r => {
                    const li = document.createElement("li");
                    li.className = "list-group-item";
                    li.innerHTML = `<b>${r.type}</b> - ${r.description || "No description"} <br>
      <small class="text-muted">${r.date || ""}</small>`;
                    recent.appendChild(li);
                });






            })
            .catch(err => console.error("Error fetching user reports:", err));
    });

    const links = document.querySelectorAll('.list-unstyled a');
    links.forEach(link => {
        if (link.href === window.location.href) {
            link.classList.add('active');
        }
    });

    // Logout
    document.getElementById("logoutLink").addEventListener("click", e => {
        e.preventDefault();
        localStorage.clear(); // Clear user session
        window.location.href = "dashboard.html"; // Redirect to dashboard instead of sign-in
    });

    document.addEventListener("DOMContentLoaded", () => {
        const token = localStorage.getItem("accessToken");

        if (!token) {
            // Token ‡∂±‡∑ê‡∂≠‡∑ä‡∂≠‡∂∏‡∑ä auto logout (localStorage clear + redirect)
            localStorage.clear();
            alert("‚ö†Ô∏è Session expired. Please login again.");
            window.location.href = "signUp.html";
            return;
        }

        // ‡∑Ä‡∑ê‡∂© ‡∂ö‡∂ª‡∂±‡∑ä‡∂± token ‡∂≠‡∑í‡∂∂‡∑ä‡∂∂‡∑ú‡∂≠‡∑ä dashboard load ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
    });

</script>
</body>
</html>
