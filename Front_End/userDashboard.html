<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Victim Dashboard - NDMRS</title>
    <link rel="stylesheet" href="css/userDashboard.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/your-fontawesome-kit.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

</head>
<body>
<div class="d-flex" id="wrapper">
    <!-- Sidebar -->
    <div class="bg-dark text-white p-3" id="sidebar">
        <h2 class="text-center">NDMRS</h2>
        <ul class="list-unstyled">
            <li><a href="#" class="text-white"><i class="fas fa-home"></i> Dashboard</a></li>
            <li><a href="report.html" class="text-white"><i class="fas fa-exclamation-triangle"></i> Report Disaster</a></li>
            <li><a href="myReports.html" class="text-white"><i class="fas fa-file-alt"></i> My Reports</a></li>
            <li><a href="profile.html" class="text-white"><i class="fas fa-user"></i> Profile</a></li>
            <li><a href="volunteer.html" class="text-white"><i class="fas fa-user"></i> Volunteer</a></li>
            <li><a href="signIn.html" class="text-white" id="logoutLink"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
        </ul>
    </div>

    <!-- Main Content -->
    <div id="page-content" class="p-4">
        <h2>Welcome, Victim User 👋</h2>
        <div class="row mt-4">
            <div class="col-md-4">
                <div class="card p-3 shadow-sm">
                    <h5>My Reports</h5>
                    <p id="report-count">0</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-3 shadow-sm">
                    <h5>Aid Received</h5>
                    <p id="aid-count">0</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-3 shadow-sm">
                    <h5>Pending Requests</h5>
                    <p id="pending-count">0</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card p-3 shadow-sm">
                <h5>Today’s Reported Disasters</h5>
                <div id="todayDisastersMap" style="height: 400px;"></div>
            </div>
        </div>
    </div>

</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        // Get token and user info from localStorage
        const accessToken = localStorage.getItem("accessToken");
        const username = localStorage.getItem("username");
        const role = localStorage.getItem("role");

        // Redirect to login if not logged in
        if (!accessToken) {
            alert("⚠️ You must be logged in to access this page.");
            window.location.href = "signIn.html";
            return;
        }

        // Display username in dashboard
        const welcomeHeader = document.querySelector("h2");
        if (welcomeHeader && username) {
            welcomeHeader.textContent = `Welcome, ${username} 👋`;
        }

        // Fetch user-specific dashboard stats
        fetch("http://localhost:8080/auth/reports", {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${accessToken}`
            }
        })
            .then(res => res.json())
            .then(data => {
                if (data) {
                    document.getElementById("report-count").textContent = data.totalReports || 0;
                    document.getElementById("aid-count").textContent = data.aidReceived || 0;
                    document.getElementById("pending-count").textContent = data.pendingRequests || 0;
                }
            })
            .catch(err => {
                console.error("Error fetching user data:", err);
                alert("🚨 Could not load dashboard data.");
            });

        // Logout functionality
        const logoutLink = document.getElementById("logoutLink");
        if (logoutLink) {
            logoutLink.addEventListener("click", (e) => {
                e.preventDefault();
                localStorage.clear(); // clear token and user info
                window.location.href = "signIn.html";
            });
        }
    });


    document.addEventListener("DOMContentLoaded", () => {
        const accessToken = localStorage.getItem("accessToken");

        if (!accessToken) {
            alert("⚠️ You must be logged in to access this page.");
            window.location.href = "signIn.html";
            return;
        }

        // ✅ Load today's disasters on map inside DOMContentLoaded
        fetch("http://localhost:8080/auth/reports/today", {
            headers: { "Authorization": `Bearer ${accessToken}` }
        })
            .then(res => res.json())
            .then(data => {
                const reports = data.data || [];

                // Initialize map
                const map = L.map("todayDisastersMap").setView([7.8731, 80.7718], 7);
                L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                    attribution: "&copy; OpenStreetMap contributors"
                }).addTo(map);

                // Add markers
                reports.forEach(r => {
                    if (r.latitude && r.longitude) {
                        L.marker([r.latitude, r.longitude])
                            .addTo(map)
                            .bindPopup(`<b>${r.type}</b><br>${r.description || ""}`);
                    }
                });
            })
            .catch(err => console.error("🚨 Error loading today's reports:", err));
    });

    // ✅ Fetch My Reports count
    fetch("http://localhost:8080/auth/reports/my", {
        method: "GET",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${accessToken}`
        }
    })
        .then(res => res.json())
        .then(data => {
            if (data && data.data) {
                // APIResponse.data contains the list of reports
                document.getElementById("report-count").textContent = data.data.length;
            }
        })
        .catch(err => {
            console.error("🚨 Error fetching my reports:", err);
        });


</script>
</body>
</html>
