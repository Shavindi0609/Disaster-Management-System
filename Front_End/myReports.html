<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Reports - NDMRS</title>
    <link rel="stylesheet" href="css/userDashboard.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<div class="d-flex" id="wrapper">
    <!-- User Sidebar -->
    <div class="sidebar">
        <div class="brand text-center mb-4">
            <i class="fas fa-shield-alt fa-2x"></i>
            <h2 class="mt-2">NDMRS</h2>
        </div>
        <ul class="list-unstyled">
            <li><a href="userDashboard.html"><i class="fas fa-home"></i> Dashboard</a></li>
            <li><a href="report.html"><i class="fas fa-exclamation-triangle"></i> Report Disaster</a></li>
            <li><a href="myReports.html" class="active"><i class="fas fa-file-alt"></i> My Reports</a></li>
            <li><a href="profile.html"><i class="fas fa-user"></i> Profile</a></li>
            <li><a href="donation.html"><i class="fas fa-donate"></i> Donations</a></li>
            <li><a href="dashboard.html" id="logoutLink"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
        </ul>
    </div>

    <!-- Main Content -->
    <div id="page-content" class="p-4">
        <h2>ðŸ“‘ My Reports</h2>
        <div id="reports-container" class="row mt-4">
            <!-- Reports will load here as cards -->
        </div>
    </div>
</div>

<script>
    async function loadMyReports() {
        const container = document.getElementById('reports-container');
        container.innerHTML = "";

        try {
            const accessToken = localStorage.getItem("accessToken");
            if (!accessToken) throw new Error("No access token found");

            const res = await fetch("http://localhost:8080/api/reports/my", {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${accessToken}`,
                    "Content-Type": "application/json"
                }
            });

            const result = await res.json();
            if (result.status !== 200) throw new Error(result.message || "Failed to load reports");

            const reports = result.data;

            // ðŸ”¹ Sort by createdAt (newest first)
            reports.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            if (!reports.length) {
                container.innerHTML = `<p class="text-center">No reports found</p>`;
                return;
            }

            reports.forEach(r => {
                const card = document.createElement("div");
                card.className = "col-md-4 mb-3";

                let photoHTML = r.photoBase64
                    ? `<img src="data:image/jpeg;base64,${r.photoBase64}" class="card-img-top" style="height:200px; object-fit:cover;">` : '';


                card.innerHTML = `
                <div class="card shadow-sm h-100">
                    ${photoHTML}
                    <div class="card-body">
                        <h5 class="card-title">${r.type}</h5>
                        <p class="card-text">${r.description || "-"}</p>
                        <p><b>Contact:</b> ${r.reporterContact || "-"}</p>
                        <p><b>Location:</b> ${r.latitude}, ${r.longitude}</p>
                        <p><b>Date:</b> ${new Date(r.createdAt).toLocaleString()}</p>
                        <p><b>Assigned Volunteer:</b> ${r.assignedVolunteerName || "Not Assigned"}</p>
                        <p><b>Allocated Donations:</b> $${r.allocatedDonationAmount || 0}</p>
                    </div>
                </div>
            `;

                container.appendChild(card);
            });
        } catch (err) {
            console.error("Error loading my reports:", err);
            container.innerHTML = "<p>Error loading reports.</p>";
        }
    }

    // Call on page load
    document.addEventListener("DOMContentLoaded", () => {
        loadMyReports();

        // Logout
        const logoutLink = document.getElementById("logoutLink");
        logoutLink.addEventListener("click", (e) => {
            e.preventDefault();
            localStorage.clear();
            window.location.href = "signUp.html";
        });
    });
</script>

</body>
</html>
