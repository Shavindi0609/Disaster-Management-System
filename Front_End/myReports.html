
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Reports - NDMRS</title>
    <link rel="stylesheet" href="css/userDashboard.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Modern card styles */
        .card {
            border-radius: 1rem;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .card-img-top {
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
        }

        .card-body h5 {
            font-weight: 600;
            color: #111827;
        }

        .card-body p {
            font-size: 0.9rem;
            color: #374151;
            margin-bottom: 6px;
        }

        .card-body b {
            co
    </style>
</head>
<body>
<div class="d-flex" id="wrapper">
    <!-- User Sidebar -->
    <div class="sidebar">
        <div class="brand text-center mb-4">
            <i class="fas fa-shield-alt fa-2x"></i>
            <h2 class="mt-2">NDMRS</h2>
        </div>
        <ul class="list-unstyled">
            <li><a href="userDashboard.html"><i class="fas fa-home"></i> Dashboard</a></li>
            <li><a href="report.html"><i class="fas fa-exclamation-triangle"></i> Report Disaster</a></li>
            <li><a href="myReports.html" class="active"><i class="fas fa-file-alt"></i> My Reports</a></li>
            <li><a href="profile.html"><i class="fas fa-user"></i> Profile</a></li>
            <li><a href="donation.html"><i class="fas fa-donate"></i> Donations</a></li>
            <li><a href="dashboard.html" id="logoutLink"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
        </ul>
    </div>

    <!-- Main Content -->
    <div id="page-content" class="p-4">
        <h2>ðŸ“‘ My Reports</h2>

        <!-- ðŸ”¹ Date Filter UI -->
        <div class="mb-3 row">
            <div class="col-md-4">
                <label for="dateFilter" class="form-label">Filter by Date:</label>
                <input type="date" id="dateFilter" class="form-control">
            </div>
            <div class="col-md-2 align-self-end">
                <button id="filterBtn" class="btn btn-primary">Filter</button>
            </div>
            <div class="col-md-2 align-self-end">
                <button id="resetBtn" class="btn btn-secondary">Reset</button>
            </div>
        </div>

        <!-- ðŸ”¹ Reports Container -->
        <div id="reports-container" class="row mt-4">
            <!-- Reports will load here as cards -->
        </div>
    </div>




</div>

<script>
    let currentPage = 1;
    const reportsPerPage = 6;
    let allReports = [];
    let filteredReports = []; // <-- new

    async function loadMyReports() {
        const container = document.getElementById('reports-container');
        container.innerHTML = "";

        try {
            const accessToken = localStorage.getItem("accessToken");
            if (!accessToken) throw new Error("No access token found");

            const res = await fetch("http://localhost:8080/api/reports/my", {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${accessToken}`,
                    "Content-Type": "application/json"
                }
            });

            const result = await res.json();
            if (result.status !== 200) throw new Error(result.message || "Failed to load reports");

            allReports = result.data.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            filteredReports = [...allReports]; // initially all

            if (!allReports.length) {
                container.innerHTML = `<p class="text-center">No reports found</p>`;
                return;
            }

            renderPage(currentPage);
            renderPagination();
        } catch (err) {
            console.error("Error loading my reports:", err);
            container.innerHTML = "<p>Error loading reports.</p>";
        }
    }

    function renderPage(page) {
        const container = document.getElementById('reports-container');
        container.innerHTML = "";

        const start = (page - 1) * reportsPerPage;
        const end = start + reportsPerPage;
        const reportsToShow = filteredReports.slice(start, end);

        if (!reportsToShow.length) {
            container.innerHTML = "<p class='text-center'>No reports found.</p>";
            return;
        }

        reportsToShow.forEach(r => {
            const card = document.createElement("div");
            card.className = "col-md-4 mb-3";

            let photoHTML = r.photoBase64
                ? `<img src="data:image/jpeg;base64,${r.photoBase64}" class="card-img-top" style="height:200px; object-fit:cover;">`
                : '';

            card.innerHTML = `
            <div class="card shadow-sm h-100">
                ${photoHTML}
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">${r.type}</h5>
                    <p class="card-text">${r.description || "-"}</p>
                    <p><b>Contact:</b> ${r.reporterContact || "-"}</p>
                    <p><b>Location:</b> ${r.latitude}, ${r.longitude}</p>
                    <p><b>Date:</b> ${new Date(r.createdAt).toLocaleString()}</p>
                    <p><b>Assigned Volunteer:</b> ${r.assignedVolunteerName || "Not Assigned"}</p>
                    <p><b>Allocated Donations:</b> $${r.allocatedDonationAmount || 0}</p>

                    <div class="mt-auto d-flex justify-content-between">
                        <button class="btn btn-sm btn-danger" onclick="deleteReport('${r.id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
        `;

            container.appendChild(card);
        });
    }

    function renderPagination() {
        const container = document.getElementById('reports-container');
        const paginationContainer = document.createElement("div");
        paginationContainer.className = "d-flex justify-content-center mt-4";

        const totalPages = Math.ceil(filteredReports.length / reportsPerPage);

        for (let i = 1; i <= totalPages; i++) {
            const btn = document.createElement("button");
            btn.className = `btn btn-sm mx-1 ${i === currentPage ? 'btn-primary' : 'btn-outline-primary'}`;
            btn.textContent = i;
            btn.addEventListener("click", () => {
                currentPage = i;
                renderPage(currentPage);
                renderPagination();
            });
            paginationContainer.appendChild(btn);
        }

        container.appendChild(paginationContainer);
    }

    // âœ… Date filter
    function applyFilter() {
        const selectedDate = document.getElementById("dateFilter").value; // YYYY-MM-DD
        if (selectedDate) {
            filteredReports = allReports.filter(r => r.createdAt.startsWith(selectedDate));
        } else {
            filteredReports = [...allReports];
        }
        currentPage = 1;
        renderPage(currentPage);
        renderPagination();
    }

    function resetFilter() {
        document.getElementById("dateFilter").value = "";
        filteredReports = [...allReports];
        currentPage = 1;
        renderPage(currentPage);
        renderPagination();
    }

    document.addEventListener("DOMContentLoaded", () => {
        loadMyReports();

        const logoutLink = document.getElementById("logoutLink");
        logoutLink.addEventListener("click", (e) => {
            e.preventDefault();
            localStorage.clear();
            window.location.href = "signUp.html";
        });

        // connect filter buttons
        document.getElementById("filterBtn").addEventListener("click", applyFilter);
        document.getElementById("resetBtn").addEventListener("click", resetFilter);
    });

    async function deleteReport(reportId) {
        if (!confirm("Are you sure you want to delete this report?")) return;

        try {
            const accessToken = localStorage.getItem("accessToken");
            const res = await fetch(`http://localhost:8080/api/reports/${reportId}`, {
                method: "DELETE",
                headers: {
                    "Authorization": `Bearer ${accessToken}`
                }
            });

            if (!res.ok) throw new Error("Failed to delete report");

            alert("Report deleted successfully!");
            loadMyReports();
        } catch (err) {
            console.error("Delete error:", err);
            alert("Error deleting report.");
        }
    }
</script>


</body>
</html>
