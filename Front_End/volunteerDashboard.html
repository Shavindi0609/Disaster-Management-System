<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Volunteer Dashboard - NDMS</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>

    :root {
      --main-dark: #066150;
      --main-light: #1D865C;
      --accent-color: #FF6B35;
      --bg-light: #f8f9fa;
    }

    /* General Styles */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg-light);
      margin: 0;
    }

    /* Sidebar - Horizontal Version */
    .sidebar {
      background: linear-gradient(90deg, var(--main-dark), var(--main-light));
      color: #fff;
      padding: 15px 20px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
      width: 100%;
    }

    .sidebar-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sidebar h2 {
      margin: 0;
      font-size: 22px;
      font-weight: 700;
    }

    .sidebar ul {
      display: flex;
      gap: 15px;
      padding-left: 0;
      margin: 0;
      list-style: none;
    }

    .sidebar ul li {
      margin: 0;
    }

    .sidebar ul li a {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 15px;
      text-decoration: none;
      color: #fff;
      font-size: 14px;
      font-weight: 500;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .sidebar ul li a:hover,
    .sidebar ul li a.active {
      background: rgba(255,255,255,0.2);
    }


    .report-map {
      height: 150px;       /* small map */
      width: 100%;
      border-radius: 8px;
      margin-top: 10px;
    }
    :root {
      --main-dark: #066150;
      --main-light: #1D865C;
      --accent-color: #FF6B35;
    }

    body {
      background-color: #f8f9fa;
      font-family: Arial, sans-serif;
    }

    /* Orange login button in sidebar */
    .sidebar .btn-login {
      background-color: var(--accent-color);
      border-color: var(--accent-color);
      color: #fff;
    }

    .sidebar .btn-login:hover {
      background-color: #e55a2b;
      border-color: var(--accent-color);
    }


    .dashboard-header {
      background-color: var(--main-light);
      color: #fff;
      padding: 40px 20px;
      text-align: center;
      border-radius: 10px;
      margin-bottom: 30px;
    }

    .dashboard-header h1 {
      margin-bottom: 10px;
    }

    .card-volunteer {
      border-radius: 12px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card-volunteer:hover {
      transform: translateY(-6px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }

    .card-volunteer .btn {
      background-color: var(--accent-color);
      border-color: var(--accent-color);
      color: #fff;
    }

    .card-volunteer .btn:hover {
      background-color: #e55a2b;
      transform: scale(1.05);
    }

    .volunteer-stats {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 30px;
    }


    .stat-card {
      flex: 1;
      min-width: 150px;
      max-width: 220px;
      background: var(--main-dark);
      color: #fff;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.2);
    }

    .stat-card h3 {
      font-size: 2rem;
      margin-bottom: 5px;
    }

    footer {
      background-color: var(--main-dark);
      color: #fff;
      padding: 2rem 0;
      text-align: center;
      margin-top: 50px;
    }

  </style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
  <div class="sidebar-content">
    <div class="brand">
      <i class="fas fa-shield-alt"></i>
      <h2>NDMRS</h2>
    </div>
    <ul class="list-unstyled">
      <li><a href="dashboard.html"><i class="fas fa-home"></i> Home</a></li>
      <li><a href="volunteerMyReports.html"><i class="fas fa-exclamation-triangle"></i> My Report Disaster</a></li>
      <li><a href="myReports.html"><i class="fas fa-file-alt"></i> My Reports</a></li>
      <li><a href="profile.html"><i class="fas fa-user"></i> Profile</a></li>
      <li><a href="volunteer.html" class="active"><i class="fas fa-hand-holding-heart"></i> Volunteer</a></li>
      <li><a href="donation.html"><i class="fas fa-donate"></i> Donations</a></li>
      <li><a href="signUp.html" id="logoutLink"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
    </ul>
    <a href="#" id="volunteerLoginBtn" class="btn btn-login btn-sm rounded-pill me-2">Log In as a Volunteer</a>
  </div>
</div>

<!-- Dashboard Header -->
<section class="dashboard-header">
  <div class="container">
    <h1>Welcome, Volunteer!</h1>
    <p>Stay informed and manage your tasks efficiently.</p>
  </div>
</section>

<!-- Volunteer Stats -->
<section class="container volunteer-stats">
  <div class="stat-card">
    <h3>12</h3>
    <p>Active Tasks</p>
  </div>
  <div class="stat-card">
    <h3>3</h3>
    <p>Upcoming Events</p>
  </div>
  <div class="stat-card">
    <h3>5</h3>
    <p>Completed Trainings</p>
  </div>
  <div class="stat-card">
    <h3>24</h3>
    <p>Total Hours</p>
  </div>
</section>

<!-- Volunteer Tasks -->
<section class="container mb-5">
  <h2 class="mb-4 fw-bold" style="color:var(--main-dark)">My Tasks</h2>
  <div class="row g-4">

    <div class="col-md-4">
      <div class="card card-volunteer h-100">
        <div class="card-body">
          <h5 class="card-title">Flood Relief Assistance</h5>
          <p class="card-text">Assist with food and water distribution in affected areas.</p>
          <a href="#" class="btn btn-sm rounded-pill">View Details</a>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card card-volunteer h-100">
        <div class="card-body">
          <h5 class="card-title">Community Training</h5>
          <p class="card-text">Help organize workshops for community preparedness.</p>
          <a href="#" class="btn btn-sm rounded-pill">View Details</a>
        </div>
      </div>
    </div>

<!--    &lt;!&ndash; volunteerDashboard.html snippet &ndash;&gt;-->
<!--    <div class="container mt-4">-->
<!--      <h2>My Assigned Reports</h2>-->
<!--      <div id="assignedReports" class="mt-3"></div>-->
<!--    </div>-->

  </div>
</section>

<!--&lt;!&ndash; Response Modal &ndash;&gt;-->
<!--<div class="modal fade" id="responseModal" tabindex="-1">-->
<!--  <div class="modal-dialog">-->
<!--    <div class="modal-content rounded-3 shadow">-->
<!--      <div class="modal-header bg-success text-white">-->
<!--        <h5 class="modal-title">Submit Response</h5>-->
<!--        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>-->
<!--      </div>-->
<!--      <div class="modal-body">-->
<!--        <form id="responseForm">-->
<!--          <input type="hidden" id="reportIdInput">-->
<!--          <div class="mb-3">-->
<!--            <label for="statusUpdate" class="form-label fw-bold">Your Status</label>-->
<!--            <textarea class="form-control" id="statusUpdate" rows="3"-->
<!--                      placeholder="E.g. Reached location, distributed relief..."></textarea>-->
<!--          </div>-->
<!--          <div class="mb-3">-->
<!--            <label for="photoUpload" class="form-label fw-bold">Upload Photo (optional)</label>-->
<!--            <input class="form-control" type="file" id="photoUpload" accept="image/*">-->
<!--          </div>-->
<!--          <button type="submit" class="btn btn-success w-100 rounded-pill">-->
<!--            ✅ Submit Response-->
<!--          </button>-->
<!--        </form>-->
<!--      </div>-->
<!--    </div>-->
<!--  </div>-->
<!--</div>-->

<!-- Footer -->
<footer>
  <p>© 2025 NDMS Volunteer Dashboard | Supporting Community Preparedness</p>
</footer>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const token = localStorage.getItem("accessToken");
    const email = localStorage.getItem("email");

    if (!token || !email) {
      alert("⚠️ Please login first!");
      window.location.href = "volunteerLogin.html";
      return;
    }

    try {
      // 🔹 Get volunteer by email to find their ID
      const volRes = await fetch(`http://localhost:8080/api/volunteers?email=${encodeURIComponent(email)}`, {
        headers: {"Authorization": `Bearer ${token}`}
      });

      if (!volRes.ok) throw new Error("Failed to fetch volunteer details");

      const volData = await volRes.json();

      // ⚡ Fix: volData.data is an array
      const volunteer = volData.data.find(v => v.email === email);

      if (!volunteer) throw new Error("Volunteer not found for email: " + email);

      const volunteerId = volunteer.id;

      // 🔹 Fetch assigned reports for this volunteer
      const reportRes = await fetch(`http://localhost:8080/api/reports/volunteer/${volunteerId}`, {
        headers: {"Authorization": `Bearer ${token}`}
      });

      if (!reportRes.ok) throw new Error("Failed to fetch assigned reports");

      const reportData = await reportRes.json();
      const reports = reportData.data || [];

      const container = document.getElementById("assignedReports");
      container.innerHTML = "";

      if (reports.length === 0) {
        container.innerHTML = "<p>No reports assigned to you yet.</p>";
      } else {
        reports.forEach(r => {
          const div = document.createElement("div");
          div.className = "card mb-3"; // a bit more spacing for map

          // Format the date nicely
          const reportDate = new Date(r.date || r.createdAt); // adjust field name if different
          const formattedDate = reportDate.toLocaleDateString() + " " + reportDate.toLocaleTimeString();

          // Insert the report info + a container for the map
          div.innerHTML = `
 <!-- Inside each report card -->
<div class="card-body">
  <h5>${r.type}</h5>
  <p>${r.description}</p>
  <p><b>Reporter:</b> ${r.reporterContact || "N/A"}</p>
  <p><b>Date:</b> ${formattedDate}</p>
  <p><b>Assigned by Admin</b></p>
  <div id="map-${r.id}" class="report-map"></div>
  <button class="btn btn-success btn-sm mt-3"
          data-bs-toggle="modal"
          data-bs-target="#responseModal"
          onclick="openResponseModal(${r.id})">
    📍 Mark as Responded
  </button>
</div>


          `;
          container.appendChild(div);

          // Initialize the small map for this report
          const map = L.map(`map-${r.id}`, {
            zoomControl: false,
            dragging: false
          }).setView([r.latitude, r.longitude], 13);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
          }).addTo(map);

          // Add a marker at the report location
          L.marker([r.latitude, r.longitude]).addTo(map);
        });


      }
    } catch (err) {
      console.error("Error fetching assigned reports:", err);
      document.getElementById("assignedReports").innerHTML = `<p class="text-danger">Error loading reports: ${err.message}</p>`;
    }
  });

  let selectedReportId = null;

  function openResponseModal(reportId) {
    selectedReportId = reportId;
    document.getElementById("reportIdInput").value = reportId;
  }

  document.getElementById("responseForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const token = localStorage.getItem("accessToken");
    const reportId = selectedReportId;
    const statusUpdate = document.getElementById("statusUpdate").value;
    const photoFile = document.getElementById("photoUpload").files[0];

    if (!statusUpdate.trim()) {
      alert("⚠️ Please enter a status update!");
      return;
    }

    const formData = new FormData();
    formData.append("statusUpdate", statusUpdate);
    formData.append("respondedAt", new Date().toISOString());
    if (photoFile) {
      formData.append("photo", photoFile);
    }

    try {
      const res = await fetch(`http://localhost:8080/api/reports/${reportId}/respond`, {
        method: "POST",
        headers: { "Authorization": `Bearer ${token}` },
        body: formData
      });

      if (!res.ok) throw new Error("Failed to submit response");

      // Close modal
      const modal = bootstrap.Modal.getInstance(document.getElementById("responseModal"));
      modal.hide();

      alert("✅ Response submitted successfully!");
      location.reload();
    } catch (err) {
      console.error("Error:", err);
      alert("❌ Error submitting response: " + err.message);
    }
  });

</script>


</body>
</html>
