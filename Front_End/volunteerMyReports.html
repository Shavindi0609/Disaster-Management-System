<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>


    <style>
        .report-map {
            height: 150px;       /* small map */
            width: 100%;
            border-radius: 8px;
            margin-top: 10px;
        }
        :root {
            --main-dark: #066150;
            --main-light: #1D865C;
            --accent-color: #FF6B35;
        }

        body {
            background-color: #f8f9fa;
            font-family: Arial, sans-serif;
        }

    </style>
</head>
<body>

<!-- volunteerDashboard.html snippet -->
<div class="container mt-4">
    <h2>My Assigned Reports</h2>
    <div id="assignedReports" class="mt-3"></div>
</div>


<!-- Response Modal -->
<div class="modal fade" id="responseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content rounded-3 shadow">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Submit Response</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="responseForm">
                    <input type="hidden" id="reportIdInput">
                    <div class="mb-3">
                        <label for="statusUpdate" class="form-label fw-bold">Your Status</label>
                        <textarea class="form-control" id="statusUpdate" rows="3"
                                  placeholder="E.g. Reached location, distributed relief..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="photoUpload" class="form-label fw-bold">Upload Photo (optional)</label>
                        <input class="form-control" type="file" id="photoUpload" accept="image/*">
                    </div>
                    <button type="submit" class="btn btn-success w-100 rounded-pill">
                        ‚úÖ Submit Response
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const token = localStorage.getItem("accessToken");
        const email = localStorage.getItem("email");

        if (!token || !email) {
            alert("‚ö†Ô∏è Please login first!");
            window.location.href = "volunteerLogin.html";
            return;
        }

        try {
            // üîπ Get volunteer by email to find their ID
            const volRes = await fetch(`http://localhost:8080/api/volunteers?email=${encodeURIComponent(email)}`, {
                headers: {"Authorization": `Bearer ${token}`}
            });

            if (!volRes.ok) throw new Error("Failed to fetch volunteer details");

            const volData = await volRes.json();

            // ‚ö° Fix: volData.data is an array
            const volunteer = volData.data.find(v => v.email === email);

            if (!volunteer) throw new Error("Volunteer not found for email: " + email);

            const volunteerId = volunteer.id;

            // üîπ Fetch assigned reports for this volunteer
            const reportRes = await fetch(`http://localhost:8080/api/reports/volunteer/${volunteerId}`, {
                headers: {"Authorization": `Bearer ${token}`}
            });

            if (!reportRes.ok) throw new Error("Failed to fetch assigned reports");

            const reportData = await reportRes.json();
            const reports = reportData.data || [];

            const container = document.getElementById("assignedReports");
            container.innerHTML = "";

            if (reports.length === 0) {
                container.innerHTML = "<p>No reports assigned to you yet.</p>";
            } else {
                reports.forEach(r => {
                    const div = document.createElement("div");
                    div.className = "card mb-3"; // a bit more spacing for map

                    // Format the date nicely
                    const reportDate = new Date(r.date || r.createdAt); // adjust field name if different
                    const formattedDate = reportDate.toLocaleDateString() + " " + reportDate.toLocaleTimeString();

                    // Insert the report info + a container for the map
                    div.innerHTML = `
 <!-- Inside each report card -->
<div class="card-body">
  <h5>${r.type}</h5>
  <p>${r.description}</p>
  <p><b>Reporter:</b> ${r.reporterContact || "N/A"}</p>
  <p><b>Date:</b> ${formattedDate}</p>
  <p><b>Assigned by Admin</b></p>
  <div id="map-${r.id}" class="report-map"></div>
  <button class="btn btn-success btn-sm mt-3"
          data-bs-toggle="modal"
          data-bs-target="#responseModal"
          onclick="openResponseModal(${r.id})">
    üìç Mark as Responded
  </button>
</div>


          `;
                    container.appendChild(div);

                    // Initialize the small map for this report
                    const map = L.map(`map-${r.id}`, {
                        zoomControl: false,
                        dragging: false
                    }).setView([r.latitude, r.longitude], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors'
                    }).addTo(map);

                    // Add a marker at the report location
                    L.marker([r.latitude, r.longitude]).addTo(map);
                });


            }
        } catch (err) {
            console.error("Error fetching assigned reports:", err);
            document.getElementById("assignedReports").innerHTML = `<p class="text-danger">Error loading reports: ${err.message}</p>`;
        }
    });

    let selectedReportId = null;

    function openResponseModal(reportId) {
        selectedReportId = reportId;
        document.getElementById("reportIdInput").value = reportId;
    }

    document.getElementById("responseForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const token = localStorage.getItem("accessToken");
        const reportId = selectedReportId;
        const statusUpdate = document.getElementById("statusUpdate").value;
        const photoFile = document.getElementById("photoUpload").files[0];

        if (!statusUpdate.trim()) {
            alert("‚ö†Ô∏è Please enter a status update!");
            return;
        }

        const formData = new FormData();
        formData.append("statusUpdate", statusUpdate);
        formData.append("respondedAt", new Date().toISOString());
        if (photoFile) {
            formData.append("photo", photoFile);
        }

        try {
            const res = await fetch(`http://localhost:8080/api/reports/${reportId}/respond`, {
                method: "POST",
                headers: { "Authorization": `Bearer ${token}` },
                body: formData
            });

            if (!res.ok) throw new Error("Failed to submit response");

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById("responseModal"));
            modal.hide();

            alert("‚úÖ Response submitted successfully!");
            location.reload();
        } catch (err) {
            console.error("Error:", err);
            alert("‚ùå Error submitting response: " + err.message);
        }
    });

</script>

</body>
</html>