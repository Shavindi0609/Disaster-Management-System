
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - Disaster Management</title>
    <link rel="stylesheet" href="css/admin.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">


    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


</head>
<body>
<!-- Sidebar -->
<div class="sidebar">
    <h2 class="text-center">Admin Panel</h2>
    <ul class="list-unstyled">
        <li><a href="#" class="active" onclick="showPage('dashboard')">
            <i class="fa fa-home"></i> Dashboard</a></li>
        <li><a href="#" onclick="showPage('volunteers')">
            <i class="fa fa-hand-holding-heart"></i> Volunteers</a></li>
        <li><a href="#" onclick="showPage('donors')">
            <i class="fa fa-donate"></i> Donors</a></li>
        <li><a href="#" onclick="showPage('users')">
            <i class="fa fa-user-cog"></i> Users</a></li>
        <li><a href="#" onclick="showWeekDisastersPage()">
            <i class="fa fa-calendar-week"></i> Reports In Week</a></li>
        <li><a href="ResponsesInWeek.html">
            <i class="fa fa-file-alt"></i>Reports & Responses In Week</a></li>
        <li><a href="#" onclick="showReportsPage()">
            <i class="fa fa-chart-line"></i> Allocate Donations</a></li>
        <li><a href="allResponses.html">
            <i class="fa fa-file-alt"></i> History</a></li>
        <li><a href="dashboard.html" id="logoutLink">
            <i class="fas fa-sign-out-alt"></i> Logout</a></li>
    </ul>
</div>


<!-- Main Content -->
<div class="main-content">
    <div class="topbar">
        <h1 id="pageTitle">Dashboard</h1>
        <span>üë§ Admin</span>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboard" class="page active">
        <div class="stats-grid">
            <!--            <div class="stat-card">-->
            <!--                <h2 id="statEmployees">0</h2>-->
            <!--                <p>Employees</p>-->
            <!--            </div>-->

            <div class="stat-card">
                <h2 id="statTodayDisasters">0</h2>
                <p>Today's Disasters</p>
            </div>

            <div class="stat-card">
                <h2 id="statVolunteers">0</h2>
                <p>Volunteers</p>
            </div>
            <div class="stat-card">
                <h2 id="statDonors">0</h2>
                <p>Donors</p>
            </div>

            <div class="stat-card">
                <h2 id="statDonations">$0 / $0</h2>
                <p>Total Donations</p>
            </div>

            <div class="stat-card">
                <h2 id="statAvailableBalance">$0</h2>
                <p>Available Balance</p>
            </div>


            <!-- Admin Notifications List -->
            <div class="card">
                <h3>Notifications</h3>
                <ul id="adminNotifications" class="list-group"></ul>
            </div>

            <!-- Toast Notification Container -->
            <div id="toastContainer" style="
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
"></div>



        </div>

        <!-- Dashboard row with map bigger on left -->
        <div class="dashboard-row d-flex gap-3">
            <!-- Disaster Map left (bigger) -->
            <div class="map-card" style="flex: 1 1 60%;">
                <div class="card shadow-sm">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-map-marker-alt"></i> Today‚Äôs Reported Disasters</h5>
                        <select id="adminFilterType" class="form-select w-auto">
                            <option value="all">All</option>
                            <option value="Flood">Flood</option>
                            <option value="Cyclone">Cyclone</option>
                            <option value="Earthquake">Earthquake</option>
                            <option value="Landslide">Landslide</option>
                        </select>
                    </div>
                    <div class="card-body p-0">
                        <div id="adminTodayMap" style="height: 400px; border-radius: 0 0 15px 15px;"></div>
                    </div>
                    <div class="p-3">
                        <small><b>Legend:</b>
                            <span style="color:blue">‚óè Flood</span> |
                            <span style="color:green">‚óè Cyclone</span> |
                            <span style="color:orange">‚óè Landslide</span> |
                            <span style="color:red">‚óè Earthquake</span>
                        </small>
                    </div>
                </div>
            </div>

            <!-- Chart right (smaller) -->
            <div class="chart-card" style="flex: 1 1 40%;">
                <canvas id="dashboardChart"></canvas>
            </div>
        </div>

    </div>


    <!-- Volunteers Page -->
    <div id="volunteers" class="page">
        <div class="card">
            <h3>Add Volunteer</h3>
            <form id="addVolunteerForm">
                <div class="form-group"><label>Name</label><input type="text" id="volName" required></div>
                <div class="form-group"><label>Email</label><input type="email" id="volEmail" required></div>
                <div class="form-group"><label>Phone</label><input type="text" id="volPhone" required></div>
                <div class="form-group"><label>Skills</label><input type="text" id="volSkills"></div>
                <button type="submit">Add Volunteer</button>
            </form>
        </div>

        <div class="card">
            <h3>Volunteer List</h3>
            <input type="text" id="volunteerSearch" placeholder="Search volunteers..." onkeyup="filterVolunteers()" class="search-bar">
            <div class="card-container" id="volunteerList"></div>
        </div>
    </div>

    <!-- Donors Page -->
    <div id="donors" class="page">
        <div class="card">
            <h3>Add Donor</h3>
            <form id="addDonorForm">
                <div class="form-group"><label>Name</label><input type="text" id="donName" required></div>
                <div class="form-group"><label>Email</label><input type="email" id="donEmail" required></div>
                <div class="form-group"><label>Donation Amount</label><input type="number" id="donAmount" required></div>
                <button type="submit">Add Donor</button>
            </form>
        </div>
        <div class="card">
            <h3>Donor List</h3>
            <div class="card-container" id="donorList"></div>
        </div>
    </div>

    <!-- Users Page -->
    <div id="users" class="page">
        <div class="card">
            <h3>User List</h3>
            <div class="card-container" id="userList"></div>
        </div>
    </div>

    <!-- Reports Page -->
    <div id="reports" class="page">
        <div class="card">
            <h3>Disaster Reports</h3>
            <div id="reportsMap" style="height: 400px; margin-bottom: 20px;"></div>
            <div class="card-container" id="reportsList"></div>
        </div>
    </div>

    <!-- Assign Volunteer Modal -->
    <div id="assignModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAssignModal()">&times;</span>
            <h2>Assign Volunteer</h2>
            <select id="volunteerSelect" class="form-select"></select>
            <button class="btn btn-success mt-2" onclick="assignVolunteer()">Assign</button>

        </div>
    </div>

    <!-- Allocate Donation Modal -->
    <div id="allocateModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAllocateModal()">&times;</span>
            <h2>Allocate Donation to Report</h2>
            <input type="number" id="allocateAmount" placeholder="Enter allocation amount" class="form-control mb-2">
            <button class="btn btn-warning" onclick="submitAllocation()">Allocate</button>
        </div>
    </div>


    <!-- Main Content ‡∂ë‡∂ö‡∑ö ‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä page ‡∂ë‡∂ö -->
    <div id="weekDisasters" class="page">
        <div class="card">
            <h3>Disasters in Last 7 Days</h3>
            <div id="weekMap" style="height: 400px; margin-bottom: 20px;"></div>
            <div class="card-container" id="weekReportsList"></div>
        </div>
    </div>
</div>



    <!-- Popup Modal -->
    <div id="popupModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Edit</h2>
            <form id="updateForm"></form>
        </div>
    </div>

<script src="js/admin.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.2/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    async function submitResponse(reportId, formData) {
        const res = await fetch(`/api/reports/${reportId}/respond`, {
            method: "POST",
            body: formData,
            headers: {
                "Authorization": "Bearer " + localStorage.getItem("token")
            }
        });

        const response = await res.json(); // This is ReportResponse

        const notification = {
            reportId: response.report.id,
            volunteerEmail: response.volunteer.email,
            statusUpdate: response.statusUpdate,
            notifiedAt: new Date().toISOString()
        };

        addNotificationToUI(notification);
    }

    function addNotificationToUI(notification) {
        const container = document.getElementById("adminNotifications"); // ‚úÖ correct id
        const li = document.createElement("li");
        li.className = "list-group-item";
        li.innerHTML = `
            <b>Report #${notification.reportId}</b><br>
            Volunteer: ${notification.volunteerEmail}<br>
            ${notification.statusUpdate}<br>
            <small>${new Date(notification.notifiedAt).toLocaleString()}</small>
        `;
        container.prepend(li);
    }
</script>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {

        // üîπ Centralized fetch with token
        function fetchWithToken(url, options = {}) {
            const token = localStorage.getItem("accessToken");
            if (!token) {
                alert("‚ö†Ô∏è Session expired. Please login again.");
                localStorage.clear();
                window.location.href = "login.html";
                return Promise.reject("No token found");
            }

            options.headers = {
                ...options.headers,
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            };

            return fetch(url, options).then(res => {
                if (!res.ok) {
                    if (res.status === 401 || res.status === 403) {
                        alert("Session expired or forbidden. Please login again.");
                        localStorage.clear();
                        window.location.href = "login.html";
                    }
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                return res.json();
            });

        }

        // üîπ Fetch Today's Reports
        fetchWithToken("http://localhost:8080/api/reports/today")
            .then(data => {
                document.getElementById("statTodayDisasters").textContent = data.data.length;
            })
            .catch(err => console.error("Error fetching today's reports:", err));

        // üîπ Fetch Volunteers count & list
        fetchWithToken("http://localhost:8080/api/volunteers")
            .then(data => {
                const activeVolunteers = data.data.filter(v => v.active);
                document.getElementById("statVolunteers").textContent = activeVolunteers.length;

                const volunteerList = document.getElementById("volunteerList");
                volunteerList.innerHTML = "";
                activeVolunteers.forEach(v => {
                    const card = document.createElement("div");
                    card.className = "card mb-2";
                    card.innerHTML = `
                <div class="card-body">
                    <h5 class="card-title">${v.name}</h5>
                    <p>Email: ${v.email}</p>
                    <p>Phone: ${v.phone}</p>
                    <p>Skills: ${v.skills || '-'}</p>
                </div>`;
                    volunteerList.appendChild(card);
                });
            })
            .catch(err => console.error("Error fetching volunteers:", err));

        // üîπ Fetch Donors count
        fetchWithToken("http://localhost:8080/api/donors/count")
            .then(data => {
                document.getElementById("statDonors").textContent = data.data;
            })
            .catch(err => console.error("Error fetching donors count:", err));

        // üîπ Fetch Donations total
        fetchWithToken("http://localhost:8080/api/donations/total")
            .then(data => {
                document.getElementById("statDonations").textContent = "$" + data.data;
            })
            .catch(err => console.error("Error fetching total donations:", err));

        // üîπ Fetch Donations monthly for chart
        fetchWithToken("http://localhost:8080/api/donations/monthly")
            .then(data => {
                const months = Object.keys(data.data);
                const amounts = Object.values(data.data);

                const ctx = document.getElementById("dashboardChart").getContext("2d");
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Donations',
                            data: amounts,
                            borderColor: '#ff3d67',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } }
                    }
                });
            })
            .catch(err => console.error("Error fetching monthly donations:", err));

    });

    // ------------------- MAPS AND REPORT FUNCTIONS -------------------
    let reportsMap, reportMarkers = [];
    let weekMap, weekMarkers = [];
    let adminMap, adminMarkers = [];
    let currentReportId, currentDonationReportId;

    // let currentAllocateReportId;
    let currentAllocateReportId;

    function openAllocateModal(reportId) {
        currentAllocateReportId = reportId;
        document.getElementById("allocateAmount").value = '';
        document.getElementById("allocateModal").style.display = 'block';
    }

    function closeAllocateModal() {
        document.getElementById("allocateModal").style.display = 'none';
    }

    async function submitAllocation() {
        const amount = parseFloat(document.getElementById("allocateAmount").value);
        if (!amount || amount <= 0) return alert("Enter valid amount");

        // üîπ frontend check total balance
        const totalBalanceResp = await fetchWithToken("http://localhost:8080/api/donations/total");
        const totalAvailable = totalBalanceResp.data;
        if (amount > totalAvailable) return alert("Not enough funds available!");

        try {
            const updatedReport = await fetchWithToken(
                `http://localhost:8080/api/reports/${currentAllocateReportId}/allocate?amount=${amount}`,
                { method: "PUT" }
            );

            alert("‚úÖ Donation allocated successfully!");
            closeAllocateModal();
            // Update total donations and available balance after allocation
            // After allocating donation
            updateDonationsStats();
            updateAvailableBalance();



            // Update total donations
            const total = await fetchWithToken("http://localhost:8080/api/donations/total");
            document.getElementById("statDonations").textContent = "$" + total.data;

            // Update report card
            const reportCard = document.querySelector(`.card-body[data-report-id='${currentAllocateReportId}']`);
            if (reportCard) {
                let allocatedRow = reportCard.querySelector(".allocated-donation");
                if (!allocatedRow) {
                    allocatedRow = document.createElement("p");
                    allocatedRow.classList.add("allocated-donation");
                    reportCard.appendChild(allocatedRow);
                }
                allocatedRow.innerHTML = `<b>Allocated Donations:</b> $${updatedReport.allocatedDonationAmount}`;
            }
        } catch (err) {
            console.error(err);
            alert(err.message || "Error allocating donation.");
        }
    }

    // ------------------- REPORTS -------------------
    async function loadReports() {
        const container = document.getElementById('reportsList');
        container.innerHTML = "";

        if (!reportsMap) {
            reportsMap = L.map('reportsMap').setView([7.8731, 80.7718], 7);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(reportsMap);
        } else reportsMap.invalidateSize();

        reportMarkers.forEach(m => reportsMap.removeLayer(m));
        reportMarkers = [];

        try {
            const data = await fetchWithToken("http://localhost:8080/api/reports/all");

            // üîπ Sort by createdAt (newest ‚Üí oldest)
            data.data.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            data.data.forEach(report => {
                // Add marker to map
                const marker = L.marker([report.latitude, report.longitude]).addTo(reportsMap)
                    .bindPopup(`<b>${report.type}</b><br>${report.description}`);
                reportMarkers.push(marker);

                const card = document.createElement('div');
                card.className = 'card mb-3';

                // üîπ Add photo if exists
                let photoHTML = report.photoBase64 ? `<img src="data:image/jpeg;base64,${report.photoBase64}" style="width:150px; display:block; margin-bottom:10px;">` : '';

                card.innerHTML = `
            <div class="card-body" data-report-id="${report.id}">
                <h5 class="card-title">${report.type}</h5>
                ${photoHTML}
                <p class="card-text">${report.description}</p>
                <p><b>Contact:</b> ${report.reporterContact || 'N/A'}</p>
                <p><b>Location:</b> ${report.latitude.toFixed(4)}, ${report.longitude.toFixed(4)}</p>
                <p><b>Date:</b> ${report.createdAt ? new Date(report.createdAt).toLocaleString() : '-'}</p>
                <p><b>Assigned Volunteer:</b> <span class="assigned-volunteer">
                    ${report.assignedVolunteer ? report.assignedVolunteer.name : 'Not Assigned'}
                </span></p>
                <p class="allocated-donation"><b>Allocated Donations:</b> $${report.allocatedDonationAmount || 0}</p>
                <button class="btn btn-primary" onclick="openAssignModal(${report.id})">Assign Volunteer</button>
                <button class="btn btn-warning" onclick="openAllocateModal(${report.id})">Allocate Donation</button>
            </div>`;

                container.appendChild(card);
            });
        } catch (err) {
            console.error(err);
            container.innerHTML = "<p>Error loading reports.</p>";
        }
    }

    function showReportsPage() {
        showPage('reports');
        loadReports();
    }

    // ------------------- ASSIGN VOLUNTEER -------------------
    async function openAssignModal(reportId) {
        currentReportId = reportId;
        const modal = document.getElementById('assignModal');
        modal.style.display = 'block';

        const data = await fetchWithToken("http://localhost:8080/api/volunteers");
        const activeVolunteers = data.data.filter(v => v.active);
        const select = document.getElementById("volunteerSelect");
        select.innerHTML = "";

        if (activeVolunteers.length === 0) {
            const option = document.createElement("option");
            option.textContent = "No active volunteers available";
            option.disabled = true;
            select.appendChild(option);
        } else {
            activeVolunteers.forEach(v => {
                const option = document.createElement("option");
                option.value = v.id;
                option.textContent = `${v.name} (${v.phone})`;
                select.appendChild(option);
            });
        }
    }
    function closeAssignModal() { document.getElementById('assignModal').style.display = 'none'; }

    async function assignVolunteer() {
        const volunteerId = document.getElementById("volunteerSelect").value;
        try {
            const updatedReport = await fetchWithToken(`http://localhost:8080/api/reports/${currentReportId}/assign/${volunteerId}`, { method: "PUT" });
            if (updatedReport) {
                alert("Volunteer assigned successfully!");
                closeAssignModal();
                const allCards = document.querySelectorAll(`.card-body[data-report-id='${currentReportId}']`);
                allCards.forEach(card => {
                    const volunteerSpan = card.querySelector(".assigned-volunteer");
                    if (volunteerSpan) volunteerSpan.textContent = updatedReport.assignedVolunteer ? updatedReport.assignedVolunteer.name : "Not Assigned";
                });
            }
        } catch (err) { console.error(err); alert("Error assigning volunteer."); }
    }

    // ------------------- ADMIN MAP -------------------
    async function loadAdminDisasters(filter = "all") {
        if (!adminMap) {
            adminMap = L.map("adminTodayMap").setView([7.8731, 80.7718], 7);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(adminMap);
            adminMarkers = [];
        }

        try {
            const data = await fetchWithToken("http://localhost:8080/api/reports/today");
            adminMarkers.forEach(m => adminMap.removeLayer(m));
            adminMarkers = [];

            data.data.forEach(r => {
                if (r.latitude && r.longitude && (filter === "all" || r.type === filter)) {
                    const color = r.type === "Flood" ? "blue" :
                        r.type === "Cyclone" ? "green" :
                            r.type === "Landslide" ? "orange" :
                                "red";
                    const marker = L.circleMarker([r.latitude, r.longitude], { radius: 8, color, fillColor: color, fillOpacity: 0.7 }).addTo(adminMap)
                        .bindPopup(`<b>${r.type}</b><br>${r.description || ""}`);
                    adminMarkers.push(marker);
                }
            });
        } catch (err) { console.error(err); }
    }
    document.getElementById("adminFilterType").addEventListener("change", e => loadAdminDisasters(e.target.value));
    loadAdminDisasters();

    // ------------------- WEEK DISASTERS -------------------
    async function loadWeekDisasters() {
        const container = document.getElementById("weekReportsList");
        container.innerHTML = "";

        if (!weekMap) {
            weekMap = L.map("weekMap").setView([7.8731, 80.7718], 7);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(weekMap);
            weekMarkers = [];
        } else weekMap.invalidateSize();

        weekMarkers.forEach(m => weekMap.removeLayer(m));
        weekMarkers = [];

        try {
            const data = await fetchWithToken("http://localhost:8080/api/reports/last-week");

            // üîπ Sort by createdAt (newest ‚Üí oldest)
            data.data.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            if (!data.data.length) { container.innerHTML = "<p>No disasters reported in the last 7 days.</p>"; return; }

            data.data.forEach(r => {
                if (r.latitude && r.longitude) {
                    const color = r.type === "Flood" ? "blue" :
                        r.type === "Cyclone" ? "green" :
                            r.type === "Landslide" ? "orange" :
                                "red";
                    const marker = L.circleMarker([r.latitude, r.longitude], { radius: 8, color, fillColor: color, fillOpacity: 0.7 }).addTo(weekMap)
                        .bindPopup(`<b>${r.type}</b><br>${r.description || ""}`);
                    weekMarkers.push(marker);
                }

                const card = document.createElement("div");
                card.className = "card mb-3";
                let photoHTML = r.photoBase64 ? `<img src="data:image/jpeg;base64,${r.photoBase64}" style="width:150px; display:block; margin-bottom:10px;">` : '';
                card.innerHTML = `
                <div class="card-body" data-report-id="${r.id}">
                    <h5 class="card-title">${r.type}</h5>
                    ${photoHTML}
                    <p class="card-text">${r.description || ""}</p>
                    <p><b>Contact:</b> ${r.reporterContact || 'N/A'}</p>
                    <p><b>Date:</b> ${r.createdAt ? new Date(r.createdAt).toLocaleString() : '-'}</p>
                    <p><b>Assigned Volunteer:</b> <span class="assigned-volunteer">${r.assignedVolunteer ? r.assignedVolunteer.name : 'Not Assigned'}</span></p>
                    <button class="btn btn-primary" onclick="openAssignModal(${r.id})">Assign Volunteer</button>
                </div>`;
                container.appendChild(card);
            });
        } catch (err) { console.error(err); container.innerHTML = "<p>Error loading disasters.</p>"; }
    }
    function showWeekDisastersPage() { showPage('weekDisasters'); loadWeekDisasters(); }

    // ------------------- LOGOUT -------------------
    document.getElementById("logoutLink").addEventListener("click", e => {
        e.preventDefault();
        localStorage.clear();
        window.location.href = "dashboard.html";
    });


    async function updateDonationsStats() {
        try {
            const response = await fetchWithToken("http://localhost:8080/api/donations/total"); // singular
            const total = response.data; // assuming it returns number

            // If your API provides both totalDonated and availableBalance separately, adjust accordingly
            document.getElementById("statDonations").textContent = `$${total.toFixed(2)} / $${total.toFixed(2)}`;
        } catch (err) {
            console.error("Error fetching donations stats:", err);
            document.getElementById("statDonations").textContent = "$0 / $0";
        }
    }


    // Call on page load
    updateDonationsStats();


    // üîπ Update available balance
    async function updateAvailableBalance() {
        try {
            const data = await fetchWithToken("http://localhost:8080/api/donations/available-balance");
            document.getElementById("statAvailableBalance").textContent = `$${data.data.toFixed(2)}`;


        } catch (err) {
            console.error("Error fetching available balance:", err);
            document.getElementById("statAvailableBalance").textContent = "$0";
        }
    }

    // Call on page load
    document.addEventListener("DOMContentLoaded", () => {
        updateAvailableBalance();
    });



</script>




</body>
</html>
