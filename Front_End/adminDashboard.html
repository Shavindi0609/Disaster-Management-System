<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - Disaster Management</title>
    <link rel="stylesheet" href="css/admin.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<!-- Sidebar -->
<div class="sidebar">
    <h2>Admin Panel</h2>
    <a href="#" class="active" onclick="showPage('dashboard')">Dashboard</a>
    <a href="#" onclick="showPage('employees')">Employees</a>
    <a href="#" onclick="showPage('volunteers')">Volunteers</a>
    <a href="#" onclick="showPage('donors')">Donors</a>
    <a href="#" onclick="showPage('users')">Users</a>
    <a href="#" onclick="showReportsPage()">Reports</a>


</div>

<!-- Main Content -->
<div class="main-content">
    <div class="topbar">
        <h1 id="pageTitle">Dashboard</h1>
        <span>ðŸ‘¤ Admin</span>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboard" class="page active">
        <div class="stats-grid">
            <div class="stat-card">
                <h2 id="statEmployees">0</h2>
                <p>Employees</p>
            </div>
            <div class="stat-card">
                <h2 id="statVolunteers">0</h2>
                <p>Volunteers</p>
            </div>
            <div class="stat-card">
                <h2 id="statDonors">0</h2>
                <p>Donors</p>
            </div>
            <div class="stat-card">
                <h2 id="statDonations">$0</h2>
                <p>Total Donations</p>
            </div>
        </div>

        <!-- Chart -->
        <div class="chart-card">
            <canvas id="dashboardChart"></canvas>
        </div>
    </div>

    <!-- Employees Page -->
    <div id="employees" class="page">
        <div class="card">
            <h3>Add Employee</h3>
            <form id="addEmployeeForm">
                <div class="form-group"><label>Name</label><input type="text" id="empName" required></div>
                <div class="form-group"><label>Email</label><input type="email" id="empEmail" required></div>
                <div class="form-group"><label>Position</label><input type="text" id="empPosition" required></div>
                <button type="submit">Add Employee</button>
            </form>
        </div>
        <div class="card">
            <h3>Employee List</h3>
            <div class="card-container" id="employeeList"></div>
        </div>
    </div>

    <!-- Volunteers Page -->
    <div id="volunteers" class="page">
        <div class="card">
            <h3>Add Volunteer</h3>
            <form id="addVolunteerForm">
                <div class="form-group"><label>Name</label><input type="text" id="volName" required></div>
                <div class="form-group"><label>Email</label><input type="email" id="volEmail" required></div>
                <div class="form-group"><label>Phone</label><input type="text" id="volPhone" required></div>
                <div class="form-group"><label>Skills</label><input type="text" id="volSkills"></div>
                <button type="submit">Add Volunteer</button>
            </form>
        </div>

        <div class="card">
            <h3>Volunteer List</h3>
            <input type="text" id="volunteerSearch" placeholder="Search volunteers..." onkeyup="filterVolunteers()" class="search-bar">
            <div class="card-container" id="volunteerList"></div>
        </div>
    </div>

    <!-- Donors Page -->
    <div id="donors" class="page">
        <div class="card">
            <h3>Add Donor</h3>
            <form id="addDonorForm">
                <div class="form-group"><label>Name</label><input type="text" id="donName" required></div>
                <div class="form-group"><label>Email</label><input type="email" id="donEmail" required></div>
                <div class="form-group"><label>Donation Amount</label><input type="number" id="donAmount" required></div>
                <button type="submit">Add Donor</button>
            </form>
        </div>
        <div class="card">
            <h3>Donor List</h3>
            <div class="card-container" id="donorList"></div>
        </div>
    </div>

    <!-- Users Page -->
    <div id="users" class="page">
        <div class="card">
            <h3>User List</h3>
            <div class="card-container" id="userList"></div>
        </div>
    </div>

    <!-- Reports Page -->
    <div id="reports" class="page">
        <div class="card">
            <h3>Disaster Reports</h3>
            <div id="reportsMap" style="height: 400px; margin-bottom: 20px;"></div>
            <div class="card-container" id="reportsList"></div>
        </div>
    </div>

    <!-- Assign Volunteer Modal -->
    <div id="assignModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAssignModal()">&times;</span>
            <h2>Assign Volunteer</h2>
            <select id="volunteerSelect" class="form-select"></select>
            <button class="btn btn-success mt-2" onclick="assignVolunteer()">Assign</button>
        </div>
    </div>

</div>



<!-- Popup Modal -->
<div id="popupModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2 id="modalTitle">Edit</h2>
        <form id="updateForm"></form>
    </div>
</div>

<script src="js/admin.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {

        // ðŸ”¹ Fetch Employees count
        fetch("http://localhost:8080/auth/employees/count")
            .then(res => res.json())
            .then(data => {
                document.getElementById("statEmployees").textContent = data.data;
            });

        // ðŸ”¹ Fetch Volunteers count
        fetch("http://localhost:8080/auth/volunteers/count")
            .then(res => res.json())
            .then(data => {
                document.getElementById("statVolunteers").textContent = data.data;
            });

        // ðŸ”¹ Fetch Donors count
        fetch("http://localhost:8080/auth/donors/count")
            .then(res => res.json())
            .then(data => {
                document.getElementById("statDonors").textContent = data.data;
            });

        // ðŸ”¹ Donations amount (à¶‡à¶­à·Šà¶­à¶§à¶¸ DB à¶‘à¶šà·š à¶­à·’à¶ºà·™à¶±à·€à· à¶±à¶¸à·Š backend à¶‘à¶šà·™à¶±à·Š API à¶‘à¶šà¶šà·Š à·„à¶¯à¶±à·Šà¶±)
        fetch("http://localhost:8080/auth/donations/total")
            .then(res => res.json())
            .then(data => {
                document.getElementById("statDonations").textContent = "$" + data.data;
            });

        fetch("http://localhost:8080/auth/donations/monthly")
            .then(res => res.json())
            .then(data => {
                const months = Object.keys(data.data);
                const amounts = Object.values(data.data);

                const ctx = document.getElementById("dashboardChart").getContext("2d");
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Donations',
                            data: amounts,
                            borderColor: '#ff3d67',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {legend: {display: false}}
                    }
                });
            });
    });
</script>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    let currentReportId = null;

    async function loadReports() {
        const reportsContainer = document.getElementById('reportsList');
        reportsContainer.innerHTML = "";

        // Initialize map
        const map = L.map('reportsMap').setView([7.8731, 80.7718], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        try {
            const res = await fetch("http://localhost:8080/auth/reports/all");
            const data = await res.json();
            const reports = data.data;

            reports.forEach(report => {
                // Map marker
                L.marker([report.latitude, report.longitude])
                    .addTo(map)
                    .bindPopup(`<b>${report.type}</b><br>${report.description}`);

                // Report card
                const card = document.createElement('div');
                card.className = 'card mb-3';
                card.innerHTML = `
    <div class="card-body" data-report-id="${report.id}">
        <h5 class="card-title">${report.type}</h5>
        <p class="card-text">${report.description}</p>
        <p><b>Contact:</b> ${report.reporterContact || 'N/A'}</p>
        <p><b>Location:</b> ${report.latitude.toFixed(4)}, ${report.longitude.toFixed(4)}</p>
        <p><b>Assigned Volunteer:</b>
            <span class="assigned-volunteer">
                ${report.assignedVolunteer ? report.assignedVolunteer.name : 'Not Assigned'}
            </span>
        </p>
        <button class="btn btn-primary" onclick="openAssignModal(${report.id})">Assign Volunteer</button>
    </div>
`;
                reportsContainer.appendChild(card);

            });
        } catch (err) {
            console.error("Error fetching reports:", err);
            reportsContainer.innerHTML = "<p>Error loading reports.</p>";
        }
    }

    function showReportsPage() {
        showPage('reports');
        loadReports();
    }

    // ðŸ”¹ Modal functions
    async function openAssignModal(reportId) {
        currentReportId = reportId;
        const modal = document.getElementById('assignModal');
        modal.style.display = 'block';

        // Load volunteers
        // âœ… Correct
        const res = await fetch("http://localhost:8080/auth/volunteers");
        const data = await res.json();
        const volunteers = data.data;

        const select = document.getElementById("volunteerSelect");
        select.innerHTML = "";
        volunteers.forEach(v => {
            const option = document.createElement("option");
            option.value = v.id;
            option.textContent = v.name + " (" + v.phone + ")";
            select.appendChild(option);
        });
    }

    function closeAssignModal() {
        document.getElementById('assignModal').style.display = 'none';
    }

    async function assignVolunteer() {
        const volunteerId = document.getElementById("volunteerSelect").value;
        const token = localStorage.getItem("accessToken");

        const res = await fetch(`http://localhost:8080/auth/reports/${currentReportId}/assign/${volunteerId}`, {
            method: "PUT",
            headers: {
                "Authorization": `Bearer ${token}`
            }
        });

        if (res.ok) {
            const updatedReport = await res.json(); // backend return report object
            alert("Volunteer assigned successfully!");
            closeAssignModal();

            // ðŸ”¹ UI à¶‘à¶šà·šà¶¸ update à¶šà¶»à¶±à·Šà¶±
            const card = document.querySelector(`[data-report-id='${currentReportId}']`);
            if (card) {
                const volunteerField = card.querySelector(".assigned-volunteer");
                volunteerField.textContent = updatedReport.assignedVolunteer
                    ? updatedReport.assignedVolunteer.name
                    : "Not Assigned";
            }
        } else {
            alert("Failed to assign volunteer.");
        }
    }

</script>


</body>
</html>
