<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - Disaster Management</title>
    <link rel="stylesheet" href="css/admin.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">


    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<!-- Sidebar -->
<div class="sidebar">
    <h2 class="text-center">Admin Panel</h2>
    <ul class="list-unstyled">
        <li><a href="#" class="active" onclick="showPage('dashboard')">
            <i class="fa fa-home"></i> Dashboard</a></li>
<!--        <li><a href="#" onclick="showPage('employees')">-->
<!--            <i class="fa fa-users"></i> Employees</a></li>-->
        <li><a href="#" onclick="showPage('volunteers')">
            <i class="fa fa-hand-holding-heart"></i> Volunteers</a></li>
        <li><a href="#" onclick="showPage('donors')">
            <i class="fa fa-donate"></i> Donors</a></li>
        <li><a href="#" onclick="showPage('users')">
            <i class="fa fa-user-cog"></i> Users</a></li>
        <li><a href="#" onclick="showReportsPage()">
            <i class="fa fa-chart-line"></i> Reports</a></li>
        <li><a href="dashboard.html" id="logoutLink">
            <i class="fas fa-sign-out-alt"></i> Logout</a></li>
    </ul>
</div>


<!-- Main Content -->
<div class="main-content">
    <div class="topbar">
        <h1 id="pageTitle">Dashboard</h1>
        <span>üë§ Admin</span>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboard" class="page active">
        <div class="stats-grid">
<!--            <div class="stat-card">-->
<!--                <h2 id="statEmployees">0</h2>-->
<!--                <p>Employees</p>-->
<!--            </div>-->

            <div class="stat-card">
                <h2 id="statTodayDisasters">0</h2>
                <p>Today's Disasters</p>
            </div>

            <div class="stat-card">
                <h2 id="statVolunteers">0</h2>
                <p>Volunteers</p>
            </div>
            <div class="stat-card">
                <h2 id="statDonors">0</h2>
                <p>Donors</p>
            </div>
            <div class="stat-card">
                <h2 id="statDonations">$0</h2>
                <p>Total Donations</p>
            </div>
        </div>

        <!-- Dashboard row with map bigger on left -->
        <div class="dashboard-row d-flex gap-3">
            <!-- Disaster Map left (bigger) -->
            <div class="map-card" style="flex: 1 1 60%;">
                <div class="card shadow-sm">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-map-marker-alt"></i> Today‚Äôs Reported Disasters</h5>
                        <select id="adminFilterType" class="form-select w-auto">
                            <option value="all">All</option>
                            <option value="Flood">Flood</option>
                            <option value="Fire">Fire</option>
                            <option value="Earthquake">Earthquake</option>
                            <option value="Landslide">Landslide</option>
                        </select>
                    </div>
                    <div class="card-body p-0">
                        <div id="adminTodayMap" style="height: 400px; border-radius: 0 0 15px 15px;"></div>
                    </div>
                    <div class="p-3">
                        <small><b>Legend:</b>
                            <span style="color:blue">‚óè Flood</span> |
                            <span style="color:red">‚óè Fire</span> |
                            <span style="color:orange">‚óè Landslide</span> |
                            <span style="color:green">‚óè Earthquake</span>
                        </small>
                    </div>
                </div>
            </div>

            <!-- Chart right (smaller) -->
            <div class="chart-card" style="flex: 1 1 40%;">
                <canvas id="dashboardChart"></canvas>
            </div>
        </div>


    </div>

<!--    &lt;!&ndash; Employees Page &ndash;&gt;-->
<!--    <div id="employees" class="page">-->
<!--        <div class="card">-->
<!--            <h3>Add Employee</h3>-->
<!--            <form id="addEmployeeForm">-->
<!--                <div class="form-group"><label>Name</label><input type="text" id="empName" required></div>-->
<!--                <div class="form-group"><label>Email</label><input type="email" id="empEmail" required></div>-->
<!--                <div class="form-group"><label>Position</label><input type="text" id="empPosition" required></div>-->
<!--                <button type="submit">Add Employee</button>-->
<!--            </form>-->
<!--        </div>-->
<!--        <div class="card">-->
<!--            <h3>Employee List</h3>-->
<!--            <div class="card-container" id="employeeList"></div>-->
<!--        </div>-->
<!--    </div>-->

    <!-- Volunteers Page -->
    <div id="volunteers" class="page">
        <div class="card">
            <h3>Add Volunteer</h3>
            <form id="addVolunteerForm">
                <div class="form-group"><label>Name</label><input type="text" id="volName" required></div>
                <div class="form-group"><label>Email</label><input type="email" id="volEmail" required></div>
                <div class="form-group"><label>Phone</label><input type="text" id="volPhone" required></div>
                <div class="form-group"><label>Skills</label><input type="text" id="volSkills"></div>
                <button type="submit">Add Volunteer</button>
            </form>
        </div>

        <div class="card">
            <h3>Volunteer List</h3>
            <input type="text" id="volunteerSearch" placeholder="Search volunteers..." onkeyup="filterVolunteers()" class="search-bar">
            <div class="card-container" id="volunteerList"></div>
        </div>
    </div>

    <!-- Donors Page -->
    <div id="donors" class="page">
        <div class="card">
            <h3>Add Donor</h3>
            <form id="addDonorForm">
                <div class="form-group"><label>Name</label><input type="text" id="donName" required></div>
                <div class="form-group"><label>Email</label><input type="email" id="donEmail" required></div>
                <div class="form-group"><label>Donation Amount</label><input type="number" id="donAmount" required></div>
                <button type="submit">Add Donor</button>
            </form>
        </div>
        <div class="card">
            <h3>Donor List</h3>
            <div class="card-container" id="donorList"></div>
        </div>
    </div>

    <!-- Users Page -->
    <div id="users" class="page">
        <div class="card">
            <h3>User List</h3>
            <div class="card-container" id="userList"></div>
        </div>
    </div>

    <!-- Reports Page -->
    <div id="reports" class="page">
        <div class="card">
            <h3>Disaster Reports</h3>
            <div id="reportsMap" style="height: 400px; margin-bottom: 20px;"></div>
            <div class="card-container" id="reportsList"></div>
        </div>
    </div>

    <!-- Assign Volunteer Modal -->
    <div id="assignModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAssignModal()">&times;</span>
            <h2>Assign Volunteer</h2>
            <select id="volunteerSelect" class="form-select"></select>
            <button class="btn btn-success mt-2" onclick="assignVolunteer()">Assign</button>
        </div>
    </div>

</div>



<!-- Popup Modal -->
<div id="popupModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2 id="modalTitle">Edit</h2>
        <form id="updateForm"></form>
    </div>
</div>

<script src="js/admin.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {


        // üîπ Fetch Today's Reports
        fetch("http://localhost:8080/api/reports/today")
            .then(res => res.json())
            .then(data => {
                document.getElementById("statTodayDisasters").textContent = data.data.length;
            });

        // üîπ Fetch Volunteers count
        // üîπ Fetch Volunteers (active only) count and list
        fetch("http://localhost:8080/api/volunteers")
            .then(res => res.json())
            .then(data => {
                // Only active volunteers
                const activeVolunteers = data.data.filter(v => v.active);

                // Update stats card count
                document.getElementById("statVolunteers").textContent = activeVolunteers.length;

                // Render in volunteer list
                const volunteerList = document.getElementById("volunteerList");
                volunteerList.innerHTML = "";
                activeVolunteers.forEach(v => {
                    const card = document.createElement("div");
                    card.className = "card mb-2";
                    card.innerHTML = `
                <div class="card-body">
                    <h5 class="card-title">${v.name}</h5>
                    <p>Email: ${v.email}</p>
                    <p>Phone: ${v.phone}</p>
                    <p>Skills: ${v.skills || '-'}</p>
                </div>
            `;
                    volunteerList.appendChild(card);
                });
            })
            .catch(err => console.error("Error fetching active volunteers:", err));


        // üîπ Fetch Donors count
        fetch("http://localhost:8080/api/donors/count")
            .then(res => res.json())
            .then(data => {
                document.getElementById("statDonors").textContent = data.data;
            });

        // üîπ Donations amount (‡∂á‡∂≠‡∑ä‡∂≠‡∂ß‡∂∏ DB ‡∂ë‡∂ö‡∑ö ‡∂≠‡∑í‡∂∫‡∑ô‡∂±‡∑Ä‡∑è ‡∂±‡∂∏‡∑ä backend ‡∂ë‡∂ö‡∑ô‡∂±‡∑ä API ‡∂ë‡∂ö‡∂ö‡∑ä ‡∑Ñ‡∂Ø‡∂±‡∑ä‡∂±)
        fetch("http://localhost:8080/api/donations/total")
            .then(res => res.json())
            .then(data => {
                document.getElementById("statDonations").textContent = "$" + data.data;
            });

        fetch("http://localhost:8080/api/donations/monthly")
            .then(res => res.json())
            .then(data => {
                const months = Object.keys(data.data);
                const amounts = Object.values(data.data);

                const ctx = document.getElementById("dashboardChart").getContext("2d");
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Donations',
                            data: amounts,
                            borderColor: '#ff3d67',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {legend: {display: false}}
                    }
                });
            });
    });
</script>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    let reportsMap;
    let reportMarkers = [];

    async function loadReports() {
        const reportsContainer = document.getElementById('reportsList');
        reportsContainer.innerHTML = "";

        // Map ‡∂ë‡∂ö initialize ‡∑Ä‡∑ô‡∂±‡∑ä‡∂±‡∑ö once ‡∑Ä‡∑í‡∂≠‡∂ª‡∂∫‡∑í
        if (!reportsMap) {
            reportsMap = L.map('reportsMap').setView([7.8731, 80.7718], 7);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(reportsMap);
        }

        // Clear previous markers
        reportMarkers.forEach(m => reportsMap.removeLayer(m));
        reportMarkers = [];

        try {
            const res = await fetch("http://localhost:8080/api/reports/all");
            const data = await res.json();
            const reports = data.data;

            reports.forEach(report => {
                // Map marker
                const marker = L.marker([report.latitude, report.longitude])
                    .addTo(reportsMap)
                    .bindPopup(`<b>${report.type}</b><br>${report.description}`);
                reportMarkers.push(marker);

                // Report card
                const card = document.createElement('div');
                card.className = 'card mb-3';
                card.innerHTML = `
                <div class="card-body" data-report-id="${report.id}">
                    <h5 class="card-title">${report.type}</h5>
                    <p class="card-text">${report.description}</p>
                    <p><b>Contact:</b> ${report.reporterContact || 'N/A'}</p>
                    <p><b>Location:</b> ${report.latitude.toFixed(4)}, ${report.longitude.toFixed(4)}</p>
                    <p><b>Assigned Volunteer:</b>
                        <span class="assigned-volunteer">
                            ${report.assignedVolunteer ? report.assignedVolunteer.name : 'Not Assigned'}
                        </span>
                    </p>
                    <button class="btn btn-primary" onclick="openAssignModal(${report.id})">Assign Volunteer</button>
                </div>
            `;
                reportsContainer.appendChild(card);
            });

        } catch (err) {
            console.error("Error fetching reports:", err);
            reportsContainer.innerHTML = "<p>Error loading reports.</p>";
        }
    }


    function showReportsPage() {
        showPage('reports');
        loadReports();
    }

    // üîπ Modal functions
    async function openAssignModal(reportId) {
        currentReportId = reportId;
        const modal = document.getElementById('assignModal');
        modal.style.display = 'block';

        // Load volunteers
        const res = await fetch("http://localhost:8080/api/volunteers");
        const data = await res.json();
        const volunteers = data.data;

        // Only active volunteers
        const activeVolunteers = volunteers.filter(v => v.active);

        const select = document.getElementById("volunteerSelect");
        select.innerHTML = "";

        if (activeVolunteers.length === 0) {
            const option = document.createElement("option");
            option.textContent = "No active volunteers available";
            option.disabled = true;
            select.appendChild(option);
        } else {
            activeVolunteers.forEach(v => {
                const option = document.createElement("option");
                option.value = v.id;
                option.textContent = `${v.name} (${v.phone})`;
                select.appendChild(option);
            });
        }
    }


    function closeAssignModal() {
        document.getElementById('assignModal').style.display = 'none';
    }

    async function assignVolunteer() {
        const volunteerId = document.getElementById("volunteerSelect").value;
        const token = localStorage.getItem("accessToken");

        try {
            const res = await fetch(`http://localhost:8080/api/reports/${currentReportId}/assign/${volunteerId}`, {
                method: "PUT",
                headers: {
                    "Authorization": `Bearer ${token}`
                }
            });

            if (res.ok) {
                const updatedReport = await res.json(); // backend returns updated report object
                alert("Volunteer assigned successfully!");
                closeAssignModal();

                // üîπ Fix: Select the correct card-body element
                const cardBody = document.querySelector(`.card-body[data-report-id='${currentReportId}']`);
                if (cardBody) {
                    const volunteerField = cardBody.querySelector(".assigned-volunteer");
                    volunteerField.textContent = updatedReport.assignedVolunteer
                        ? updatedReport.assignedVolunteer.name
                        : "Not Assigned";
                }
            } else {
                alert("Failed to assign volunteer.");
            }
        } catch (err) {
            console.error("Error assigning volunteer:", err);
            alert("An error occurred while assigning volunteer.");
        }
    }


    // Load today's reports on small map
    fetch("http://localhost:8080/api/reports/today")
        .then(res => res.json())
        .then(data => {
            const reports = data.data;

            const map = L.map("todayMap").setView([7.8731, 80.7718], 7);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                attribution: "&copy; OpenStreetMap contributors"
            }).addTo(map);

            reports.forEach(r => {
                L.marker([r.latitude, r.longitude])
                    .addTo(map)
                    .bindPopup(`<b>${r.type}</b><br>${r.description}`);
            });
        });

    // Initialize small admin dashboard map
    const adminMap = L.map("adminTodayMap").setView([7.8731, 80.7718], 7);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors"
    }).addTo(adminMap);

    let adminMarkers = [];

    async function loadAdminDisasters(filter = "all") {
        try {
            const res = await fetch("http://localhost:8080/api/reports/today");
            const data = await res.json();
            const reports = data.data || [];

            // Clear previous markers
            adminMarkers.forEach(m => adminMap.removeLayer(m));
            adminMarkers = [];

            reports.forEach(r => {
                if (r.latitude && r.longitude && (filter === "all" || r.type === filter)) {
                    const color = r.type === "Flood" ? "blue" :
                        r.type === "Fire" ? "red" :
                            r.type === "Landslide" ? "orange" :
                                "green";

                    const marker = L.circleMarker([r.latitude, r.longitude], {
                        radius: 8,
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.7
                    }).addTo(adminMap)
                        .bindPopup(`<b>${r.type}</b><br>${r.description || ""}`);

                    adminMarkers.push(marker);
                }
            });
        } catch (err) {
            console.error("Error loading admin disasters:", err);
        }
    }

    // Load all disasters by default
    loadAdminDisasters();

    // Filter dropdown
    document.getElementById("adminFilterType").addEventListener("change", e => {
        loadAdminDisasters(e.target.value);
    });

    // Logout
    document.getElementById("logoutLink").addEventListener("click", e => {
        e.preventDefault();
        localStorage.clear(); // Clear user session
        window.location.href = "dashboard.html"; // Redirect to dashboard instead of sign-in
    });

    // document.addEventListener("DOMContentLoaded", () => {
    //     const accessToken = localStorage.getItem("accessToken");
    //     const username = localStorage.getItem("username");
    //     const role = localStorage.getItem("role");
    //
    //     if (!accessToken) {
    //         alert("‚ö†Ô∏è Login ‡∑Ä‡∑ô‡∂Ω‡∑è ‡∂±‡∑ê‡∂≠‡∑í ‡∂±‡∑í‡∑É‡∑è page ‡∂ë‡∂ö‡∂ß access ‡∂ö‡∂ª‡∂±‡∑ä‡∂± ‡∂∂‡∑ê‡∑Ñ‡∑ê.");
    //         window.location.href = "signIn.html";
    //         return;
    //     }
    //
    //     // username ‡∑É‡∑Ñ role display ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
    //     document.getElementById("username").textContent = username;
    //     console.log("User role:", role);
    // });

    document.addEventListener("DOMContentLoaded", () => {
        const token = localStorage.getItem("accessToken");

        if (!token) {
            // Token ‡∂±‡∑ê‡∂≠‡∑ä‡∂≠‡∂∏‡∑ä auto logout (localStorage clear + redirect)
            localStorage.clear();
            alert("‚ö†Ô∏è Session expired. Please login again.");
            window.location.href = "signUp.html";
            return;
        }

        // ‡∑Ä‡∑ê‡∂© ‡∂ö‡∂ª‡∂±‡∑ä‡∂± token ‡∂≠‡∑í‡∂∂‡∑ä‡∂∂‡∑ú‡∂≠‡∑ä dashboard load ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
    });

</script>


</body>
</html>
